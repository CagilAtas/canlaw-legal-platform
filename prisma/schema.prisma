generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Jurisdiction {
  id               String           @id @default(cuid())
  code             String           @unique
  name             String
  fullName         String?
  jurisdictionType String
  parentId         String?
  metadata         Json             @default("{}")
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  parent           Jurisdiction?    @relation("JurisdictionHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children         Jurisdiction[]   @relation("JurisdictionHierarchy")
  legalSources     LegalSource[]
  slotDefinitions  SlotDefinition[]

  @@index([code])
  @@index([isActive])
}

model LegalDomain {
  id              String           @id @default(cuid())
  slug            String           @unique
  name            String
  description     String?
  parentId        String?
  sortOrder       Int              @default(0)
  metadata        Json             @default("{}")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  parent          LegalDomain?     @relation("DomainHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children        LegalDomain[]    @relation("DomainHierarchy")
  legalSources    LegalSource[]
  slotDefinitions SlotDefinition[]

  @@index([slug])
}

model LegalSource {
  id                 String                 @id @default(cuid())
  jurisdictionId     String
  legalDomainId      String?
  sourceType         String
  citation           String
  shortTitle         String?
  longTitle          String?
  fullText           String?
  summary            String?
  versionNumber      Int                    @default(1)
  effectiveDate      DateTime?
  repealDate         DateTime?
  inForce            Boolean                @default(true)
  officialUrl        String?
  scrapedAt          DateTime?
  aiProcessed        Boolean                @default(false)
  aiProcessedAt      DateTime?
  aiProcessingNotes  Json?
  parentSourceId     String?
  supersedesSourceId String?
  metadata           Json                   @default("{}")
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  createdBy          String?
  changeDetections   LegalChangeDetection[]
  provisions         LegalProvision[]
  jurisdiction       Jurisdiction           @relation(fields: [jurisdictionId], references: [id])
  legalDomain        LegalDomain?           @relation(fields: [legalDomainId], references: [id])
  parentSource       LegalSource?           @relation("SourceHierarchy", fields: [parentSourceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childSources       LegalSource[]          @relation("SourceHierarchy")
  supersedes         LegalSource?           @relation("SourceSupersession", fields: [supersedesSourceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supersededBy       LegalSource[]          @relation("SourceSupersession")
  slotDefinitions    SlotDefinition[]

  @@unique([jurisdictionId, citation, versionNumber])
  @@index([jurisdictionId])
  @@index([legalDomainId])
  @@index([citation])
  @@index([inForce])
  @@index([sourceType])
}

model LegalProvision {
  id                String           @id @default(cuid())
  legalSourceId     String
  provisionNumber   String
  provisionType     String?
  heading           String?
  provisionText     String
  parentProvisionId String?
  sortOrder         Int?
  versionNumber     Int              @default(1)
  effectiveDate     DateTime?
  repealDate        DateTime?
  inForce           Boolean          @default(true)
  aiSummary         String?
  aiTags            String[]
  metadata          Json             @default("{}")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  legalSource       LegalSource      @relation(fields: [legalSourceId], references: [id], onDelete: Cascade)
  parentProvision   LegalProvision?  @relation("ProvisionHierarchy", fields: [parentProvisionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childProvisions   LegalProvision[] @relation("ProvisionHierarchy")

  @@index([legalSourceId])
  @@index([parentProvisionId])
  @@index([provisionNumber])
}

model SlotDefinition {
  id                String            @id @default(cuid())
  slotKey           String            @unique
  slotName          String
  description       String?
  jurisdictionId    String?
  legalDomainId     String?
  slotCategory      String
  legalSourceId     String?
  legalProvisionIds String[]          @default([])
  legalCitationText String?
  config            Json
  versionNumber     Int               @default(1)
  isActive          Boolean           @default(true)
  supersededById    String?
  changeReason      String?
  changedBy         String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  effectiveFrom     DateTime?
  effectiveUntil    DateTime?
  jurisdiction      Jurisdiction?     @relation(fields: [jurisdictionId], references: [id])
  legalDomain       LegalDomain?      @relation(fields: [legalDomainId], references: [id])
  legalSource       LegalSource?      @relation(fields: [legalSourceId], references: [id])
  supersededBy      SlotDefinition?   @relation("SlotVersioning", fields: [supersededById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supersedes        SlotDefinition[]  @relation("SlotVersioning")
  dependedOnBy      SlotDependency[]  @relation("RequiredSlot")
  dependencies      SlotDependency[]  @relation("DependentSlot")
  groupMemberships  SlotGroupMember[]

  @@index([slotKey])
  @@index([jurisdictionId])
  @@index([legalDomainId])
  @@index([isActive])
  @@index([slotCategory])
}

model SlotDependency {
  id              String         @id @default(cuid())
  slotId          String
  dependsOnSlotId String
  dependencyType  String         @default("required")
  condition       Json?
  createdAt       DateTime       @default(now())
  dependsOnSlot   SlotDefinition @relation("RequiredSlot", fields: [dependsOnSlotId], references: [id], onDelete: Cascade)
  slot            SlotDefinition @relation("DependentSlot", fields: [slotId], references: [id], onDelete: Cascade)

  @@unique([slotId, dependsOnSlotId])
}

model SlotGroup {
  id             String            @id @default(cuid())
  groupKey       String            @unique
  groupName      String
  description    String?
  jurisdictionId String?
  legalDomainId  String?
  sortOrder      Int               @default(0)
  parentGroupId  String?
  metadata       Json              @default("{}")
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  parentGroup    SlotGroup?        @relation("GroupHierarchy", fields: [parentGroupId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childGroups    SlotGroup[]       @relation("GroupHierarchy")
  members        SlotGroupMember[]
}

model SlotGroupMember {
  id               String         @id @default(cuid())
  slotGroupId      String
  slotDefinitionId String
  sortOrder        Int            @default(0)
  isRequired       Boolean        @default(false)
  createdAt        DateTime       @default(now())
  slotDefinition   SlotDefinition @relation(fields: [slotDefinitionId], references: [id], onDelete: Cascade)
  slotGroup        SlotGroup      @relation(fields: [slotGroupId], references: [id], onDelete: Cascade)

  @@unique([slotGroupId, slotDefinitionId])
}

model CalculationRule {
  id                String    @id @default(cuid())
  ruleKey           String    @unique
  ruleName          String
  description       String?
  jurisdictionId    String?
  legalDomainId     String?
  legalSourceId     String?
  legalProvisionIds String[]  @default([])
  ruleConfig        Json
  versionNumber     Int       @default(1)
  isActive          Boolean   @default(true)
  effectiveFrom     DateTime?
  effectiveUntil    DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdBy         String?
}

model ScrapingJob {
  id             String    @id @default(cuid())
  jobType        String
  sourceUrl      String
  jurisdictionId String?
  legalDomainId  String?
  status         String
  startedAt      DateTime?
  completedAt    DateTime?
  errorMessage   String?
  itemsFound     Int       @default(0)
  itemsProcessed Int       @default(0)
  itemsCreated   Int       @default(0)
  itemsUpdated   Int       @default(0)
  scraperVersion String?
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())

  @@index([status])
  @@index([jurisdictionId])
}

model AIProcessingJob {
  id                    String    @id @default(cuid())
  jobType               String
  legalSourceId         String?
  legalProvisionId      String?
  status                String
  startedAt             DateTime?
  completedAt           DateTime?
  errorMessage          String?
  aiModel               String?
  promptTokens          Int?
  completionTokens      Int?
  slotsGenerated        Int       @default(0)
  calculationsGenerated Int       @default(0)
  confidenceScores      Json?
  aiOutput              Json?
  humanReviewRequired   Boolean   @default(false)
  humanReviewedAt       DateTime?
  humanReviewerId       String?
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now())

  @@index([status])
  @@index([legalSourceId])
}

model LegalChangeDetection {
  id                     String      @id @default(cuid())
  legalSourceId          String
  detectionType          String
  changeSummary          String
  oldContent             String?
  newContent             String?
  diff                   Json?
  detectedAt             DateTime    @default(now())
  detectedBy             String?
  confidenceScore        Float?
  requiresHumanReview    Boolean     @default(true)
  humanReviewed          Boolean     @default(false)
  humanReviewedAt        DateTime?
  humanReviewerId        String?
  humanReviewNotes       String?
  affectedSlotIds        String[]    @default([])
  affectedCalculationIds String[]    @default([])
  impactSeverity         String?
  metadata               Json        @default("{}")
  createdAt              DateTime    @default(now())
  legalSource            LegalSource @relation(fields: [legalSourceId], references: [id])

  @@index([legalSourceId])
  @@index([humanReviewed])
  @@index([impactSeverity])
}

model Case {
  id              String   @id @default(cuid())
  userId          String?
  jurisdictionId  String?
  legalDomainId   String?
  status          String   @default("draft")
  slotValues      Json     @default("{}")
  calculationsLog Json     @default("[]")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([jurisdictionId])
}

model AuditLog {
  id           String   @id @default(cuid())
  tableName    String
  recordId     String
  operation    String
  oldData      Json?
  newData      Json?
  changedBy    String?
  changedAt    DateTime @default(now())
  changeReason String?

  @@index([tableName, recordId])
  @@index([changedAt])
}
